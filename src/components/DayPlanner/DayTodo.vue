<!--
  Component: DayTodo.vue
-->
<template>
  <div class="table-container">
    <table class="full-width-table">
      <colgroup>
        <!-- ÂãæÈÄâ -->
        <col class="col-check" />
        <!-- ÂºÄÂßã -->
        <col class="col-start" />
        <!-- ÁªìÊùü -->
        <col class="col-end" />
        <!-- ÊéíÂ∫è -->
        <col class="col-rank" />
        <!-- ÊÑèÂõæ -->
        <col class="col-intent" />
        <!-- ÊûúÊûú -->
        <col class="col-fruit" />
        <!-- Áä∂ÊÄÅ -->
        <col class="col-status" />
      </colgroup>

      <thead>
        <tr>
          <th class="col-check"></th>
          <th class="col-start">ÂºÄÂßã</th>
          <th class="col-end">ÁªìÊùü</th>
          <th class="col-rank">ÊéíÂ∫è</th>
          <th class="col-intent">ÊÑèÂõæ</th>
          <th class="col-fruit">ÊûúÊûú</th>
          <th class="col-status">Áä∂ÊÄÅ</th>
        </tr>
      </thead>

      <tbody>
        <template v-if="sortedTodos.length > 0">
          <!-- Ë°å -->
          <tr
            v-for="todo in sortedTodos"
            :key="todo.id"
            :class="{
              'active-row': todo.activityId === activeId,
              'selected-row': todo.id === selectedRowId,
              'done-row': todo.status === 'done',
              'cancel-row': todo.status === 'cancelled',
            }"
            @click.stop="handleRowClick(todo)"
            style="cursor: pointer"
          >
            <!-- ÂçïÂÖÉÊ†º -->
            <!-- 1 ÂÆåÊàêÁä∂ÊÄÅ -->
            <td class="col-check">
              <n-checkbox
                v-if="todo.status !== 'cancelled'"
                :checked="todo.status === 'done'"
                @update:checked="handleCheckboxChange(todo.id, $event)"
              />
              <n-icon
                v-else
                class="cancel-icon"
                color="var(--color-text-secondary)"
              >
                <DismissSquare20Filled />
              </n-icon>
            </td>

            <!-- 2 ÂºÄÂßãÊó∂Èó¥ -->
            <td
              class="col-start"
              @dblclick.stop="startEditing(todo.id, 'start')"
              :title="
                editingRowId === todo.id && editingField === 'start'
                  ? ''
                  : 'ÂèåÂáªÁºñËæë'
              "
            >
              <input
                class="start-input time-input"
                v-if="editingRowId === todo.id && editingField === 'start'"
                v-model="editingValue"
                @blur="saveEdit(todo)"
                @keyup.enter="saveEdit(todo)"
                @keyup.esc="cancelEdit"
                :data-todo-id="todo.id"
                maxlength="5"
                autocomplete="off"
              />
              <span v-else>{{
                todo.startTime ? timestampToTimeString(todo.startTime) : "-"
              }}</span>
            </td>

            <!-- 3 ÁªìÊùüÊó∂Èó¥ -->
            <td
              class="col-end"
              @dblclick.stop="startEditing(todo.id, 'done')"
              :title="
                editingRowId === todo.id && editingField === 'done'
                  ? ''
                  : 'ÂèåÂáªÁºñËæë'
              "
            >
              <input
                class="done-input time-input"
                v-if="editingRowId === todo.id && editingField === 'done'"
                v-model="editingValue"
                @blur="saveEdit(todo)"
                @keyup.enter="saveEdit(todo)"
                @keyup.esc="cancelEdit"
                :data-todo-id="todo.id"
                maxlength="5"
                autocomplete="off"
              />
              <span v-else>{{
                todo.doneTime ? timestampToTimeString(todo.doneTime) : "-"
              }}</span>
            </td>

            <!-- 4 ÊéíÂ∫è -->
            <td class="col-rank" @click.stop="startEditingPriority(todo)">
              <n-input-number
                class="rank-input"
                v-if="editingTodo && editingTodo.id === todo.id"
                v-model:value="editingPriority"
                :min="0"
                :max="11"
                size="small"
                :show-button="false"
                placeholder=" "
                @blur="finishEditing"
                @keydown.enter="finishEditing"
              />

              <span
                v-else
                class="priority-badge"
                :class="'priority-' + todo.priority"
              >
                {{ todo.priority > 0 ? todo.priority : "‚Äî" }}
              </span>
            </td>

            <!-- 5 ÊÑèÂõæ -->
            <td
              class="col-intent"
              :class="{
                'done-cell': todo.status === 'done',
                'cancel-cell': todo.status === 'cancelled',
              }"
              @dblclick.stop="startEditing(todo.id, 'title')"
              :title="
                editingRowId === todo.id && editingField === 'title'
                  ? ''
                  : 'ÂèåÂáªÁºñËæë'
              "
            >
              <input
                class="title-input"
                v-if="editingRowId === todo.id && editingField === 'title'"
                v-model="editingValue"
                @blur="saveEdit(todo)"
                @keyup.enter="saveEdit(todo)"
                @keyup.esc="cancelEdit"
                @click.stop
                :data-todo-id="todo.id"
              />
              <span class="ellipsis" v-else>{{
                todo.activityTitle ?? "-"
              }}</span>
            </td>

            <!-- 6 ÊûúÊûú -->
            <td class="col-fruit">
              <div class="pomo-container">
                <!-- Â∞ÜÊâÄÊúâÁï™ËåÑÈíüÂÜÖÂÆπÂåÖË£ÖÂú®‰∏Ä‰∏™ÂÆπÂô®‰∏≠ -->
                <div class="pomo-groups">
                  <template v-for="(est, index) in todo.estPomo" :key="index">
                    <div class="pomo-group">
                      <template v-for="i in est" :key="i">
                        <n-checkbox
                          :class="{
                            'pomo-cherry': todo.pomoType === 'üçí',
                            'pomo-grape': todo.pomoType === 'üçá',
                            'pomo-tomato': todo.pomoType === 'üçÖ',
                          }"
                          :checked="isPomoCompleted(todo, index, i)"
                          :disabled="todo.status === 'cancelled'"
                          @update:checked="
                            (checked: any) =>
                              handlePomoCheck(todo, index, i, checked)
                          "
                        />
                      </template>
                      <span
                        class="pomo-separator"
                        v-if="todo.estPomo && index < todo.estPomo.length - 1"
                        >|</span
                      >
                    </div>
                  </template>
                </div>
                <div
                  v-if="todo.status !== 'done' && todo.status !== 'cancelled'"
                  class="est-buttons"
                >
                  <!-- Âà†Èô§‰º∞ËÆ°ÊåâÈíÆ  -->
                  <n-button
                    class="button-left"
                    v-if="
                      todo.pomoType != 'üçí' &&
                      todo.estPomo &&
                      todo.estPomo.length > 1 &&
                      todo.estPomo.length < 4
                    "
                    text
                    @click="handleDeleteEstimate(todo)"
                    title="ÂáèÂ∞ëÈ¢Ñ‰º∞Áï™ËåÑÊï∞Èáè"
                  >
                    <template #icon>
                      <n-icon size="18" color="var(--color-background-dark)">
                        <CaretLeft12Filled />
                      </n-icon>
                    </template>
                  </n-button>

                  <!-- Êñ∞Â¢û‰º∞ËÆ°ÊåâÈíÆ  -->
                  <n-button
                    class="button-right"
                    :class="{ 'bidirection-mode': todo.estPomo.length === 2 }"
                    v-if="
                      todo.pomoType != 'üçí' &&
                      todo.estPomo &&
                      todo.estPomo.length < 3
                    "
                    text
                    type="default"
                    @click="handleAddEstimate(todo)"
                    title="Â¢ûÂä†È¢Ñ‰º∞Áï™ËåÑÊï∞Èáè"
                  >
                    <template #icon>
                      <n-icon size="18" color="var(--color-background-dark)">
                        <CaretRight12Filled />
                      </n-icon>
                    </template>
                  </n-button>
                </div>
              </div>
            </td>

            <!-- 7 Áä∂ÊÄÅ -->
            <td class="status-col">
              <div
                class="status-cell"
                :class="{
                  'check-mode':
                    todo.status === 'done' || todo.status === 'cancelled',
                }"
              >
                <div
                  class="records-stat"
                  v-if="todo.taskId"
                  title="ËÉΩÈáèÂÄº | Â•ñËµèÂÄº | ÂÜÖÈÉ®ÊâìÊâ∞ | Â§ñÈÉ®ÊâìÊâ∞"
                >
                  {{ averageValue(todo.energyRecords) }}|{{
                    averageValue(todo.rewardRecords)
                  }}|{{ countInterruptions(todo.interruptionRecords, "I") }}|{{
                    countInterruptions(todo.interruptionRecords, "E")
                  }}
                </div>
                <div
                  class="button-group"
                  v-if="todo.status !== 'done' && todo.status !== 'cancelled'"
                >
                  <!-- ËøΩË∏™‰ªªÂä°ÊåâÈíÆ -->
                  <n-button
                    v-if="!todo.taskId"
                    text
                    type="info"
                    @click="handleConvertToTask(todo)"
                    title="ËøΩË∏™‰ªªÂä°"
                  >
                    <template #icon>
                      <n-icon size="18">
                        <ChevronCircleDown48Regular />
                      </n-icon>
                    </template>
                  </n-button>
                  <!-- <n-button
                  v-if="todo.status !== 'done'"
                  text
                  type="info"
                  @click="handleRepeatTodo(todo.id)"
                  title="ÈáçÂ§çÂæÖÂäûÔºåÊñ∞Âª∫Ê¥ªÂä®"
                >
                  <template #icon>
                    <n-icon size="18">
                      <ArrowRepeatAll24Regular />
                    </n-icon>
                  </template>
                </n-button> -->

                  <!-- ÂèñÊ∂à‰ªªÂä°ÊåâÈíÆ -->
                  <n-button
                    v-if="!todo.realPomo"
                    text
                    type="info"
                    @click="handleCancelTodo(todo.id)"
                    title="ÂèñÊ∂à‰ªªÂä°Ôºå‰∏çÈÄÄÂõûÊ¥ªÂä®Ê∏ÖÂçï"
                  >
                    <template #icon>
                      <n-icon size="18">
                        <DismissCircle20Regular />
                      </n-icon>
                    </template>
                  </n-button>
                  <!-- ÈÄÄÂõû‰ªªÂä°ÊåâÈíÆ = ‰∏çÂÜçÂú®‰ªäÊó• -->
                  <n-button
                    v-if="!todo.realPomo && !todo.taskId"
                    text
                    type="info"
                    @click="handleSuspendTodo(todo.id)"
                    title="Êí§ÈîÄ‰ªªÂä°ÔºåÈÄÄÂõûÊ¥ªÂä®Ê∏ÖÂçï"
                  >
                    <template #icon>
                      <n-icon size="18">
                        <ChevronCircleRight48Regular />
                      </n-icon>
                    </template>
                  </n-button>
                </div>
              </div>
            </td>
          </tr>
        </template>
        <tr v-else class="empty-row">
          <td colspan="7" style="text-align: center; padding: 10px">
            ÊöÇÊó†ÂæÖÂäû
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <n-popover
    v-model:show="showPopover"
    trigger="manual"
    placement="top-end"
    style="width: 200px"
  >
    <template #trigger>
      <div
        style="
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 1px;
          height: 1px;
        "
      ></div>
    </template>
    {{ popoverMessage }}
  </n-popover>
  <!-- Ê∑ªÂä†ËæìÂÖ•Ê°ÜÂºπÁ™ó -->
  <n-modal
    v-model:show="showEstimateInput"
    preset="dialog"
    title="Êñ∞Â¢ûÁï™ËåÑÈíü‰º∞ËÆ°"
    positive-text="Á°ÆËÆ§"
    negative-text="ÂèñÊ∂à"
    @positive-click="confirmAddEstimate"
    @negative-click="cancelAddEstimate"
    style="width: 300px"
  >
    <n-input-number
      v-model:value="newEstimate"
      :min="1"
      :max="5"
      placeholder="ËØ∑ËæìÂÖ•‰º∞ËÆ°ÁöÑÁï™ËåÑÊï∞"
      style="width: 100%"
    />
  </n-modal>
</template>
<script setup lang="ts">
import type { Todo, TodoWithTaskRecords } from "@/core/types/Todo";
import { timestampToTimeString } from "@/core/utils";
import {
  ChevronCircleRight48Regular,
  ChevronCircleDown48Regular,
  DismissCircle20Regular,
  // ArrowRepeatAll24Regular,
  DismissSquare20Filled,
  CaretLeft12Filled,
  CaretRight12Filled,
} from "@vicons/fluent";
import { NCheckbox, NInputNumber, NPopover, NButton, NIcon } from "naive-ui";
import { ref, computed, nextTick } from "vue";
import { taskService } from "@/services/taskService";
import { Task } from "@/core/types/Task";

// ÁºñËæëÁî®
const editingRowId = ref<number | null>(null);
const editingField = ref<null | "title" | "start" | "done">(null);
const editingValue = ref("");

// Ê∑ªÂä†Áä∂ÊÄÅÊù•ÊéßÂà∂ÊèêÁ§∫‰ø°ÊÅØ
const showPopover = ref(false);
const popoverMessage = ref("");

// Ê∑ªÂä†Áä∂ÊÄÅÊù•ÊéßÂà∂ËæìÂÖ•Ê°ÜÁöÑÊòæÁ§∫
const showEstimateInput = ref(false);
const currentTodoId = ref<number | null>(null);
const newEstimate = ref<number>(1);

// ÂÆö‰πâ Props
const props = defineProps<{
  todos: TodoWithTaskRecords[];
  activeId: number | null | undefined;
  selectedRowId: number | null; // Êñ∞Â¢ûÔºö‰ªéÁà∂ÁªÑ‰ª∂Êé•Êî∂ÈÄâ‰∏≠Ë°åID
}>();

const emit = defineEmits<{
  (e: "suspend-todo", id: number): void;
  (e: "cancel-todo", id: number): void;
  // (e: "repeat-todo", id: number): void;
  (e: "update-todo-status", id: number, checked: boolean): void;
  (
    e: "batch-update-priorities",
    updates: Array<{ id: number; priority: number }>
  ): void;
  (e: "update-todo-pomo", id: number, realPomo: number[]): void;
  (e: "update-todo-est", id: number, estPomo: number[]): void;

  (e: "select-task", taskId: number | null): void;
  (e: "select-row", id: number | null): void;
  (e: "select-activity", activityId: number | null): void;
  (e: "edit-todo-title", id: number, newTitle: string): void;
  (e: "edit-todo-start", id: number, newTs: string): void;
  (e: "edit-todo-done", id: number, newTs: string): void;
  (e: "convert-todo-to-task", payload: { task: Task; todoId: number }): void;
}>();

// ÂØπÂæÖÂäû‰∫ãÈ°πÊåâ‰ºòÂÖàÁ∫ßÈôçÂ∫èÊéíÂ∫èÔºàÈ´ò‰ºòÂÖàÁ∫ßÂú®ÂâçÔºâ
const sortedTodos = computed(() => {
  if (!props.todos || props.todos.length === 0) {
    return [];
  }

  return [...props.todos].sort((a, b) => {
    // 0 ÊîæÊúÄÂêé
    if (a.priority === 0 && b.priority === 0) return 0;
    if (a.priority === 0) return 1;
    if (b.priority === 0) return -1;
    // ÂÖ∂‰ΩôË∂äÂ∞èË∂ä‰ºòÂÖà
    return a.priority - b.priority;
  });
});

// ‰ºòÂÖàÁ∫ß ÊéíÂ∫è================
const editingTodo = ref<Todo | null>(null);
const editingPriority = ref<number>(0);

// ÂºÄÂßãÁºñËæë‰ºòÂÖàÁ∫ß
function startEditingPriority(todo: Todo) {
  editingTodo.value = todo;
  editingPriority.value = todo.priority;
  nextTick(() => {
    const input = document.querySelector(".rank-input .n-input__input-el");
    if (input) {
      console.log(input);
      (input as HTMLInputElement).select();
    }
  });
}

function finishEditing() {
  if (!editingTodo.value) return;
  if (editingPriority.value === 11) {
    popoverMessage.value = "ËØ∑ËæìÂÖ•1-10";
    showPopover.value = true;
    setTimeout(() => {
      showPopover.value = false;
    }, 2000);
    editingTodo.value = null;
    return;
  }

  const current = editingTodo.value;
  const desired = editingPriority.value;

  if (current.priority === desired) {
    editingTodo.value = null;
    return;
  }

  const before = new Map<number, number>();
  props.todos.forEach((t) => before.set(t.id, t.priority));

  // ÂÖ≥ÈîÆÔºö‰∏çÂÜçÊèêÂâç‰øÆÊîπ priorityÔºåËÄåÊòØÊää current Âíå desired ‰º†ÁªôÊéíÂ∫èÂáΩÊï∞
  // ËÆ©ÊéíÂ∫èÂáΩÊï∞Ëá™Â∑±ÂéªÊô∫ËÉΩÂ§ÑÁêÜ
  relayoutPriority(props.todos, current, desired);

  // ÂêéÁª≠ÈÄªËæë‰∏çÂèò...
  const updates: Array<{ id: number; priority: number }> = [];
  props.todos.forEach((t) => {
    const oldP = before.get(t.id);
    if (oldP !== t.priority) {
      updates.push({ id: t.id, priority: t.priority });
    }
  });

  if (updates.length > 0) {
    popoverMessage.value = "‰ºòÂÖàÁ∫ßÂ∑≤Êõ¥Êñ∞";
    showPopover.value = true;
    setTimeout(() => (showPopover.value = false), 2000);
    emit("batch-update-priorities", updates);
  }

  editingTodo.value = null;
}

// ‰º†ÂÖ• current Âíå desiredÔºåËÆ©ÊéíÂ∫èÊõ¥Êô∫ËÉΩ
function relayoutPriority(todos: Todo[], current: Todo, desired: number) {
  const locked = new Set<number>();
  todos.forEach((t) => {
    if (t.status === "done" && t.priority > 0) locked.add(t.priority);
  });

  const active = todos.filter(
    (t) => t.status !== "done" && t.status !== "cancelled"
  );

  active.sort((a, b) => {
    // ‰∏∫ a Âíå b Ëé∑ÂèñÁî®‰∫éÊØîËæÉÁöÑ‚ÄúÊúâÊïà‰ºòÂÖàÁ∫ß‚Äù
    let pA = a.priority;
    let pB = b.priority;

    // Â¶ÇÊûú‰ªªÂä°ÊòØÊ≠£Âú®Ë¢´ÁßªÂä®ÁöÑÈÇ£‰∏™Ôºå‰ΩøÁî®ÂÆÉÁöÑ‚ÄúÁõÆÊ†á‰ºòÂÖàÁ∫ß‚Äù
    if (a.id === current.id) pA = desired;
    if (b.id === current.id) pB = desired;

    // Â¶ÇÊûúÊòØÊää‰∏Ä‰∏™‰ªªÂä°ÂæÄÂâçÁßªÔºà‰æãÂ¶Ç P3 -> P1Ôºâ
    // Ê≠£Âú®ÁßªÂä®ÁöÑ‰ªªÂä°Â∫îËØ•ÊéíÂú®ÁõÆÊ†á‰ΩçÁΩÆ‰ªªÂä°ÁöÑ‚ÄúÂâçÈù¢‚Äù
    if (a.id === current.id && a.priority > desired && pA === pB) {
      return -1;
    }
    // Â¶ÇÊûúÊòØÊää‰∏Ä‰∏™‰ªªÂä°ÂæÄÂêéÁßªÔºà‰æãÂ¶Ç P1 -> P3Ôºâ
    // Ê≠£Âú®ÁßªÂä®ÁöÑ‰ªªÂä°Â∫îËØ•ÊéíÂú®ÁõÆÊ†á‰ΩçÁΩÆ‰ªªÂä°ÁöÑ‚ÄúÂêéÈù¢‚Äù
    if (a.id === current.id && a.priority < desired && pA === pB) {
      return 1;
    }

    // ÂØπ‰∫éÂÖ∂‰ªñÊÉÖÂÜµÔºåÊ≠£Â∏∏ÊØîËæÉ
    // 1. Êó†Êïà‰ºòÂÖàÁ∫ßÊéíÂú®ÂêéÈù¢
    const aIsLow = pA <= 0 ? 1 : 0;
    const bIsLow = pB <= 0 ? 1 : 0;
    if (aIsLow !== bIsLow) return aIsLow - bIsLow;

    // 2. Êåâ‰ºòÂÖàÁ∫ßÊï∞Â≠óÊéíÂ∫è
    if (pA !== pB) return pA - pB;

    // 3. Á®≥ÂÆöÊéíÂ∫è
    return a.id - b.id;
  });

  // ÈáçÊñ∞ÁºñÂè∑ (ÈÄªËæë‰∏çÂèò)
  let next = 1;
  for (const t of active) {
    while (locked.has(next)) next++;
    t.priority = next;
    next++;
  }
}
// ===================================
// Êõ¥Êñ∞ÊâìÈí©Áä∂ÊÄÅ
function handleCheckboxChange(id: number, checked: boolean) {
  emit("update-todo-status", id, checked);
}

// Áï™ËåÑ‰º∞ËÆ°=============================
// Ê£ÄÊü•Áï™ËåÑÈíüÊòØÂê¶ÂÆåÊàê
function isPomoCompleted(
  todo: Todo,
  estIndex: number,
  pomoIndex: number
): boolean {
  if (!todo.realPomo || todo.realPomo.length <= estIndex) return false;
  return todo.realPomo[estIndex] >= pomoIndex;
}

// Â§ÑÁêÜÁï™ËåÑÈíüÂãæÈÄâ
function handlePomoCheck(
  todo: Todo,
  estIndex: number,
  pomoIndex: number,
  checked: boolean
) {
  // Á°Æ‰øù realPomo Êï∞ÁªÑÂ≠òÂú®‰∏îÈïøÂ∫¶‰∏é estPomo ‰∏ÄËá¥
  if (!todo.realPomo) todo.realPomo = [];
  if (!todo.estPomo) todo.estPomo = [];
  while (todo.realPomo.length < todo.estPomo.length) {
    todo.realPomo.push(0);
  }

  if (checked) {
    todo.realPomo[estIndex] = Math.max(todo.realPomo[estIndex], pomoIndex);
  } else {
    todo.realPomo[estIndex] = Math.min(todo.realPomo[estIndex], pomoIndex - 1);
  }

  // ÈÄöÁü•Áà∂ÁªÑ‰ª∂Êõ¥Êñ∞
  emit("update-todo-pomo", todo.id, todo.realPomo);
}

// Â§ÑÁêÜÊñ∞Â¢û‰º∞ËÆ°
function handleAddEstimate(todo: Todo) {
  currentTodoId.value = todo.id;
  newEstimate.value = 1;
  showEstimateInput.value = true;
}

// Á°ÆËÆ§Ê∑ªÂä†Êñ∞ÁöÑ‰º∞ËÆ°
function confirmAddEstimate() {
  if (!currentTodoId.value) return;

  const todo = props.todos.find((t) => t.id === currentTodoId.value);
  if (!todo) return;

  // Á°Æ‰øù estPomo Êï∞ÁªÑÂ≠òÂú®
  if (!todo.estPomo) todo.estPomo = [];

  // Ê∑ªÂä†Êñ∞ÁöÑ‰º∞ËÆ°ÂÄº
  todo.estPomo.push(newEstimate.value);

  // ÈÄöÁü•Áà∂ÁªÑ‰ª∂Êõ¥Êñ∞
  emit("update-todo-est", todo.id, todo.estPomo);

  // ÈáçÁΩÆÁä∂ÊÄÅÂπ∂ÂÖ≥Èó≠ÂØπËØùÊ°Ü
  showEstimateInput.value = false;
  currentTodoId.value = null;
  newEstimate.value = 1; // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
}

// ÂèñÊ∂àÊ∑ªÂä†
function cancelAddEstimate() {
  showEstimateInput.value = false;
  currentTodoId.value = null;
  newEstimate.value = 1; // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
}

// Âà†Èô§‰º∞ËÆ°
function handleDeleteEstimate(todo: Todo) {
  if (todo.estPomo && todo.estPomo.length > 0) {
    // Ë¶ÅÂà†Èô§ÁöÑ‰∏ãÊ†áÊòØÊúÄÂêé‰∏ÄÈ°π
    const delIdx = todo.estPomo.length - 1;
    if (
      todo.realPomo &&
      delIdx < todo.realPomo.length &&
      todo.realPomo[delIdx] !== undefined &&
      todo.realPomo[delIdx] !== 0
    ) {
      // realPomoÊ≠§‰ΩçÁΩÆÂ∑≤Ë¢´Â°´ÂÜôÔºåÊèêÁ§∫‰∏çËÉΩÂà†
      popoverMessage.value = "Â∑≤ÁªèÊúâÂÆûÈôÖÂÆåÊàêÔºå‰∏çÂèØÂà†Èô§~";
      showPopover.value = true;
      setTimeout(() => {
        showPopover.value = false;
      }, 2000);
      return;
    }
    // ÂèØ‰ª•Âà†
    todo.estPomo.pop();
    emit("update-todo-est", todo.id, todo.estPomo);
  } else {
    popoverMessage.value = "Ê≤°Âï¶ÔºåÂà´Âà†‰∫Ü~";
    showPopover.value = true;
    setTimeout(() => {
      showPopover.value = false;
    }, 2000);
    return;
  }
}

// ‰øÆÊîπÁÇπÂáªË°åÂ§ÑÁêÜÂáΩÊï∞
function handleRowClick(todo: Todo) {
  emit("select-row", todo.id); // Êñ∞Â¢ûÔºöÂèëÈÄÅÈÄâ‰∏≠Ë°å‰∫ã‰ª∂
  emit("select-task", todo.taskId || null);
  emit("select-activity", todo.activityId || null);
}

// ÁºñËæëÁõ∏ÂÖ≥ÂáΩÊï∞
function startEditing(todoId: number, field: "title" | "start" | "done") {
  const todo = props.todos.find((t) => t.id === todoId);
  if (!todo) return;
  editingRowId.value = todoId;
  editingField.value = field;
  editingValue.value =
    field === "title"
      ? todo.activityTitle || ""
      : field === "start"
      ? todo.taskId
        ? timestampToTimeString(todo.taskId)
        : ""
      : todo.doneTime
      ? timestampToTimeString(todo.doneTime)
      : "";

  // ‰ΩøÁî® querySelector Êù•Ëé∑ÂèñÂΩìÂâçÁºñËæëÁöÑËæìÂÖ•Ê°ÜÔºåËÄå‰∏çÊòØ‰æùËµñ ref
  nextTick(() => {
    const input = document.querySelector(
      `input.${field}-input[data-todo-id="${todoId}"]`
    );
    if (input) {
      (input as HTMLInputElement).focus();
    }
  });
}

// Ê≥®ÊÑèËøôÈáåÊòØ timestring ‰∏çÊòØtimestampÔºåÊòØÂú®HomeÁî®currentViewdateËøõË°åÁöÑËΩ¨Âåñ
function saveEdit(todo: Todo) {
  if (!editingRowId.value) return;

  if (editingField.value === "title") {
    if (editingValue.value.trim()) {
      emit("edit-todo-title", todo.id, editingValue.value.trim());
    }
  }

  if (editingField.value === "start") {
    if (isValidTimeString(editingValue.value)) {
      const ts = editingValue.value;
      emit("edit-todo-start", todo.id, ts);
    }
  }

  if (editingField.value === "done") {
    if (isValidTimeString(editingValue.value)) {
      const ts = editingValue.value;
      emit("edit-todo-done", todo.id, ts);
    } else {
      if (editingValue.value === "") {
        emit("edit-todo-done", todo.id, "");
      }
    }
  }
  cancelEdit();
}

function cancelEdit() {
  editingRowId.value = null;
  editingField.value = null;
  editingValue.value = "";
}

function isValidTimeString(str: string) {
  return (
    /^\d{2}:\d{2}$/.test(str) &&
    +str.split(":")[0] <= 24 &&
    +str.split(":")[1] < 60
  );
}

// ËΩ¨Êç¢‰∏∫‰ªªÂä°
function handleConvertToTask(todo: Todo) {
  if (todo.taskId) {
    popoverMessage.value = "ËØ•ÂæÖÂäûÂ∑≤ËΩ¨Êç¢‰∏∫‰ªªÂä°";
    showPopover.value = true;
    setTimeout(() => {
      showPopover.value = false;
    }, 2000);
    return;
  }

  const task = taskService.createTaskFromTodo(
    todo.id,
    todo.activityTitle,
    todo.projectName
  );

  if (task) {
    // Á´ãÂç≥Êõ¥Êñ∞Êú¨Âú∞ÁöÑ taskId
    todo.taskId = task.id;

    emit("convert-todo-to-task", { task: task, todoId: todo.id });
    popoverMessage.value = "ÂÆåÊàê‰ªªÂä°ËΩ¨Êç¢";
    showPopover.value = true;
    setTimeout(() => {
      showPopover.value = false;
    }, 2000);
  }
}

// suspended Todo
function handleSuspendTodo(id: number) {
  emit("suspend-todo", id);
}

function handleCancelTodo(id: number) {
  emit("cancel-todo", id);
}

// ÂèñÊ∂àrepeatÂäüËÉΩÁÆÄÂåñÈ°µÈù¢ÔºåActivityÈÉ®ÂàÜÂèØ‰ª•ÂÆåÊàêÂêåÊ†∑ÂäüËÉΩ
// function handleRepeatTodo(id: number) {
//   emit("repeat-todo", id);
// }

// 1) ËÆ°ÁÆóÂπ≥ÂùáÂÄºÔºàÈÄÇÁî®‰∫é EnergyRecord[] Êàñ RewardRecord[]Ôºâ
// Á©∫„ÄÅnull„ÄÅundefined Êàñ [] ËøîÂõû null
function averageValue<T extends { value: number }>(
  records: T[] | null | undefined
): number | string {
  if (!Array.isArray(records) || records.length === 0) return "-";
  let sum = 0,
    count = 0;
  for (const r of records) {
    const v = r?.value;
    if (typeof v === "number" && Number.isFinite(v)) {
      sum += v;
      count++;
    }
  }
  return count === 0 ? "-" : sum / count;
}

// 2) ÁªüËÆ°‰∏≠Êñ≠Á±ªÂûãÊï∞ÈáèÔºà"E" Êàñ "I"Ôºâ
// Á©∫„ÄÅnull„ÄÅundefined Êàñ [] ËøîÂõû null
function countInterruptions(
  records: { interruptionType: "E" | "I" }[] | null | undefined,
  type: "E" | "I"
): number | string {
  if (!Array.isArray(records) || records.length === 0) return "-";
  let count = 0;
  for (const r of records) if (r?.interruptionType === type) count++;
  return count;
}
</script>

<style scoped>
/* Ë°®Ê†ºÂÆπÂô®Ê†∑ÂºèÔºåÂç†Êª°È°µÈù¢ */
.table-container {
  width: 100%;
  overflow-x: auto;
}

/* Ë°®Ê†ºÂç†Êª°ÂÆΩÂ∫¶ */
.full-width-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

col.col-check {
  width: 22px;
}

col.col-start {
  width: 40px;
}

col.col-end {
  width: 40px;
}

col.col-rank {
  width: 35px;
}

col.col-intent {
  width: 60%;
  min-width: 140px;
}

col.col-fruit {
  width: 40%;
  min-width: 75px;
}

col.col-status {
  width: 76px;
}

thead th,
tbody td {
  box-sizing: border-box; /* ÈÅøÂÖç padding/border ÂΩ±ÂìçÂõ∫ÂÆöËÆ°ÁÆó */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Ë°®Â§¥Ê†∑Âºè */
thead th {
  padding: 2px;
  text-align: center;
  border-bottom: 2px solid var(--color-background-dark);
  white-space: nowrap;
  overflow: hidden;
  height: 20px;
  font-weight: 400;
  color: var(--color-text-primary);
  line-height: 1.3;
  background-color: var(--color-background) !important;
}

/* Ë°åÊ†∑Âºè */
/* ÈöîË°åÂèòËâ≤ */
tr:nth-child(even) {
  background-color: var(--color-background-light-transparent);
}

/* hover È´ò‰∫ÆÔºà‰∏çÂä† !importantÔºå‰æø‰∫éË¢´ selected/active Ë¶ÜÁõñÔºâ */
tr:hover {
  background-color: var(--color-cyan-light-transparent);
}

/* ÊøÄÊ¥ªË°åÊ†∑ÂºèÔºàË¶ÜÁõñ‰∏ÄÂàáÔºâ */
tr.active-row {
  background-color: var(--color-red-light-transparent) !important;
}

/* ÈÄâ‰∏≠Ë°åÊ†∑ÂºèÔºàË¶ÜÁõñ‰∏ÄÂàáÔºâ */
tr.selected-row {
  background-color: var(--color-yellow-transparent) !important;
}

/* ÂΩìÂêåÊó∂ active + selected Êó∂ÔºåÊòéÁ°Æ‰ª• selected ÁöÑÈ¢úËâ≤‰∏∫ÂáÜÔºàÂèØÁïôÂèØÂà†Ôºâ */
tr.active-row.selected-row {
  background-color: var(--color-yellow-transparent) !important;
}

/* Áªü‰∏ÄËøáÊ∏°ÊïàÊûú */
tr,
tr:hover,
tr.active-row,
tr.selected-row {
  transition: background-color 0.2s ease;
}

/* Ë°åÁä∂ÊÄÅÊ†∑Âºè */
tr.done-row {
  color: var(--color-text-secondary);
}

tr.done-cell {
  text-decoration: line-through var(--color-text-secondary) 0.5px;
}

tr.cancel-row {
  color: var(--color-text-secondary);
}

tr.cancel-cell {
  font-style: italic;
}

tr.empty-row {
  height: 30px;
  text-align: center;
  color: var(--color-text-secondary);
  width: 100%;
  border-bottom: 1px solid var(--color-background);
}

/* Ë°®Ê†ºÂÜÖÂÆπÊ†∑Âºè */
td {
  padding: 2px 0px;
  border-bottom: 1px solid var(--color-background-dark);
  white-space: nowrap;
  overflow: hidden;
  min-height: 25px;
  height: 25px;
}

td:first-child,
td:nth-child(2),
td:nth-child(3),
td:nth-child(4) {
  text-align: center;
}

td:nth-child(7) {
  min-height: 25px;
  height: 25px;
}

th.status-col,
td.status-col {
  white-space: nowrap;
  text-align: right;
  min-width: 0;
}

/* ÂÖÅËÆ∏ÊèèËø∞ÂàóÊòæÁ§∫ÁúÅÁï•Âè∑ */
.col-intent.ellipsis {
  display: block;
  width: 100%;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.priority-badge {
  display: inline-flex;
  align-items: center !important;
  justify-content: center !important;
  width: 16px;
  height: 16px;
  position: relative;
  top: -1px;
  border-radius: 50%;
  font-size: 12px;
  font-weight: bold;
  color: var(--color-background);
  background-color: var(--color-background-dark);
  box-shadow: 0 1px 3px var(--color-background-light);
}

/* ÂèØÊåâ priority ÂàÜ‰∏çÂêåËâ≤ */
.priority-0 {
  background-color: var(--color-background);
  color: var(--color-text-secondary);
}
.priority-1 {
  background-color: var(--color-red);
}
.priority-2 {
  background-color: var(--color-orange);
}
.priority-3 {
  background-color: var(--color-yellow);
  color: var(--color-text-primary);
}
.priority-4 {
  background-color: var(--color-green);
}
.priority-5 {
  background-color: var(--color-blue);
}
.priority-6 {
  background-color: var(--color-purple);
}
.priority-7 {
  background-color: var(--color-purple-dark);
}
.priority-8 {
  background-color: var(--color-cyan);
}
.priority-9 {
  background-color: var(--color-green-dark);
}
.priority-10 {
  background-color: var(--color-orange-dark);
}

/* ‰º∞ËÆ°Áï™ËåÑÊï∞Èáè */
.pomo-container {
  display: flex;
  align-items: center;
  white-space: nowrap;
  flex-shrink: 0;
  overflow-x: auto;
  overflow-y: hidden;
  z-index: 10;
}

.pomo-groups {
  padding-right: 1px;
  z-index: 10;
}

.pomo-group {
  display: inline-flex;
  align-items: center;
  flex-shrink: 0;
  gap: 0.5px;
}

.pomo-separator {
  color: var(--color-text-secondary);
  flex-shrink: 0;
  transform: translateY(-1px);
}

:deep(.n-checkbox) {
  --n-color-checked: transparent !important;
  --n-check-mark-color: var(--color-text-primary) !important;
}

.pomo-tomato :deep(.n-checkbox-box) {
  --n-color: var(--color-red-light-transparent);
  --n-box-shadow-focus: 0 0 0 0;
  --n-border: 1px solid var(--color-red-dark);
  --n-border-checked: 1px solid var(--color-red-dark);
}

.pomo-cherry :deep(.n-checkbox-box) {
  --n-color: var(--color-green-light-transparent);
  --n-box-shadow-focus: 0 0 0 0;
  --n-border: 1px solid var(--color-green-dark);
  --n-border-checked: 1px solid var(--color-green-dark);
}

.pomo-grape :deep(.n-checkbox-box) {
  --n-color: var(--color-purple-light-transparent);
  --n-box-shadow-focus: 0 0 0 0;
  --n-border: 1px solid var(--color-purple-dark);
  --n-border-checked: 1px solid var(--color-purple-dark);
}

.est-buttons {
  display: flex;
}

.button-left {
  position: relative;
  left: -4px;
  z-index: 5;
}

.button-right:not(.bidirection-mode) {
  position: relative;
  left: -4px;
}

.button-right.bidirection-mode {
  position: relative;
  left: -12px;
  z-index: 0;
}

/* Áä∂ÊÄÅ‰ø°ÊÅØ */
.status-cell {
  display: inline-flex;
  align-items: center;
}

/* ÁªüËÆ°ÂÄº‰∏∫ÂÜÖËÅîÂùóÔºåÈÅøÂÖçÊíëÊª° */
.records-stat {
  display: inline-flex;
  font-family: Consolas, "Courier New", Courier, monospace;
  font-size: 14px;
  padding-right: 2px;
}

/* ÊåâÈíÆÁªÑ‰∏∫ÂÜÖËÅîÂùóÔºå‰∏çÂÜçÂº∫Âà∂Ë¥¥Âè≥ÔºàÂõ†‰∏∫Êï¥ÂàóÂ∑≤Âè≥ÂØπÈΩêÔºâ */
.button-group {
  display: inline-flex;
  height: 20px;
  transform: translateY(1px);
}

:deep(.n-button) :hover {
  color: var(--color-red);
}

td.col-check {
  padding-left: 1px;
}
.cancel-icon {
  display: inline-flex;
  width: 16px;
  height: 16px;
  align-items: center;
  justify-content: center;
  transform: scale(1.4) translateY(2px) !important;
  transform-origin: center;
}

.cancel-icon svg {
  display: block;
  width: 100%;
  height: 100%;
}

.rank-input {
  border: 1px solid #40a9ff;
  width: 20px;
  height: 18px;
  border-radius: 4px;
  outline: none;
  margin-left: 6px;
}

.rank-input :deep(.n-input-wrapper) {
  height: 18px;
  line-height: 22px;
  padding-left: 2px;
  padding-right: 2px;
}

.rank-input :deep(.n-input .n-input__input-el) {
  --n-border-radius: 4px;
  --n-height: 12px;
  transform: translateY(-1px);
}

.title-input {
  width: calc(100% - 10px);
  border: 1px solid #40a9ff;
  border-radius: 4px;
  outline: none;
}

.time-input {
  border: 1px solid #40a9ff;
  border-radius: 4px;
  outline: none;
}

.start-input,
.done-input {
  width: 32px !important;
  max-width: 32px !important;
  min-width: 0 !important;
  box-sizing: border-box;
  padding: 0px 0px;
  font-size: inherit;
}
</style>
